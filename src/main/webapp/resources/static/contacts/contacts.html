<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contacts</title>
    <link rel="stylesheet" href="contacts.css">
    <link rel="stylesheet" href="../gen.css">
    <script type="text/javascript" src="../../libs/jquery_3.1.0.js"></script>
    <script src="../../libs/sock.js"></script>
    <script src="../../libs/stomp.js"></script>
    <script type="text/javascript">
        var stompClient = null;
        var orgUrl = window.parent.orgUrl;

        $(document).ready(function () {


            $(document).on('click','.person_item', function(){
                //location.href = $(this).attr('data-id') //TODO ?
                var login = $(this).attr("data-login");
                //window.parent.callFrame("/" + orgUrl + "/users/" + login); //TODO replace
                //$.get("/" + orgUrl + "/private-chat", {companion: login});
                window.parent.callFrame("/" + orgUrl + "/private-chat?companion=" + login);


            });
            connectWS();
            $.ajax({url:"http://localhost:8080/" + orgUrl + "/contacts",
                type:"GET", contentType:"application/json; charset=UTF-8", success:contactsFill, error : err});

            //setTimeout('f()',2000)

            $(window).on("beforeunload", function () {
                disconnectWS();
            });



        });

        function f() {
            stompClient.send("/app/netstatus", {}, JSON.stringify({"userId":6, "statusOn": true}));
        }

        function connectWS() {
            var socket = new SockJS('/' + orgUrl + '/ws/netstatus');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                stompClient.subscribe('/' + orgUrl + '/contlist/statusalert', function(data){
                    var user = JSON.parse(data.body);
                    var usDom = $("[data-id='" + user.userId + "']");
                    var stat = user.statusOn ? 'net_status_on' : 'net_status_off';
                    usDom.find(":first-child").attr("id", stat);
                });
            });
        }

        function disconnectWS() {
            stompClient.disconnect();
        }
        function err(ex, stat) {
            alert(ex + stat);
        }


        function contactsFill(data) {
            data.forEach(function (item) {
                renderGroup(item);
            });
        }

        function renderGroup(group) {
            var body = $("body");
            var details = '<details open="open"><summary>' + group.name + '</summary>';
            for (var i = 0; i < group.users.length; i++){
                details += renderItem(group.users[i]);
            }
            details += '</details>';
            body.append(details);
        }

        function renderItem(user) {
            var idStat = user.status ? 'net_status_on' : 'net_status_off';
            return "<div class='person_item' data-id='" + user.id + "' data-login='" + user.login +
                "'><div class='net_status_circle' id='" + idStat + "'></div><div class='person_name'>" + user.name + "</div></div>"
        }
    </script>
</head>
<body>
<!--<details open="open">
    <summary>Группа1</summary>
<div class="person_item">
    <div class="net_status_circle"></div>
    &lt;!&ndash;<img src="" class="person_photo_small">&ndash;&gt;
    <div class="person_name">Иванов Иван Иванович</div>
</div>
<div class="person_item">
    <div class="net_status_circle"></div>
    &lt;!&ndash;<img src="" class="person_photo_small">&ndash;&gt;
    <div class="person_name">Юзер2</div>
</div>
</details>
<details open="open">
    <summary>Группа2</summary>
    <div class="person_item">
        <div class="net_status_circle"></div>
        &lt;!&ndash;<img src="" class="person_photo_small">&ndash;&gt;
        <div class="person_name">Иванов Иван Иванович</div>
    </div>
    <div class="person_item">
        <div class="net_status_circle"></div>
        &lt;!&ndash;<img src="" class="person_photo_small">&ndash;&gt;
        <div class="person_name">Юзер2</div>
    </div>
</details>-->
</body>
</html>